{# templates/perfil_list.html #}
{% extends "base.html" %}
{% block content %}

<style>
h2 {
  color: black;
}

.container {
  background-color: #ffffff;
  padding: 2rem;
  border-radius: 10px;
  max-width: 80%;
  width: 70%;
}

label {
  color: #080808;
  font-weight: 500;
}
</style>

<div class="container-fluid mt-4">
  <h2>Pesquisa — Lista de Perfis</h2>

  {# Formulário de filtro por data #}
  <form method="get" class="row g-3 mb-4 align-items-end">

    <!-- Data Início -->
    <div class="col-auto">
      <label for="data_inicio" class="form-label">Data Início</label>
      <input
        type="date"
        name="data_inicio"
        id="data_inicio"
        class="form-control"
        value="{{ request.GET.data_inicio }}"
      >
    </div>
  
    <!-- Data Fim -->
    <div class="col-auto">
      <label for="data_fim" class="form-label">Data Fim</label>
      <input
        type="date"
        name="data_fim"
        id="data_fim"
        class="form-control"
        value="{{ request.GET.data_fim }}"
      >
    </div>
  
    <!-- Empresa -->
    <div class="col-auto">
      <label for="empresa" class="form-label">Empresa</label>
      <input
        type="text"
        name="empresa"
        id="empresa"
        class="form-control"
        placeholder="Ex: EmpresaA,EmpresaB"
        value="{{ request.GET.empresa }}"
      >
    </div>
  
    <!-- Perfil -->
    <div class="col-auto">
      <label for="perfil" class="form-label">Perfil</label>
      <input
        type="text"
        name="perfil"
        id="perfil"
        class="form-control"
        placeholder="Ex: Admin,User"
        value="{{ request.GET.perfil }}"
      >
    </div>
  
    <!-- Plano -->
    <div class="col-auto">
      <label for="plano" class="form-label">Plano</label>
      <input
        type="text"
        name="plano"
        id="plano"
        class="form-control"
        placeholder="Ex: Básico,Premium"
        value="{{ request.GET.plano }}"
      >
    </div>
  
    <!-- Modo -->
    <div class="col-auto">
      <label for="modo" class="form-label">Modo</label>
      <input
        type="text"
        name="modo"
        id="modo"
        class="form-control"
        placeholder="Ex: Manual,Auto"
        value="{{ request.GET.modo }}"
      >
    </div>
  
    <!-- CPF/CNPJ -->
    <div class="col-auto">
      <label for="cpf_cnpj" class="form-label">CPF/CNPJ</label>
      <input
        type="text"
        name="cpf_cnpj"
        id="cpf_cnpj"
        class="form-control"
        placeholder="Ex: 12345678900"
        value="{{ request.GET.cpf_cnpj }}"
      >
    </div>
  
    <!-- Botões -->
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Filtrar</button>
      <a href="{% url 'pesquisa_list' %}" class="btn btn-secondary">Limpar</a>
      <button type="button" class="btn btn-success" onclick="exportToPDF()">Exportar PDF</button>
    </div>
  
  </form>

  <div id="table-container">
    <table class="table table-striped table-bordered">
      <thead class="thead-light">
        <tr>
          <th>Empresa</th>
          <th>Data</th>
          <th>Modo</th>
          <th>Plano</th>
          <th>Perfil</th>
          <th>CPF/CNPJ</th>
          <th>Placa</th>
          <th>Resultado</th>
          <th>Período</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for item in perfil %}
        <tr>
          <td>{{ item.empresa }}</td>
          <td>{{ item.data }}</td>
          <td>{{ item.get_modo_display }}</td>
          <td>{{ item.get_plano_display }}</td>
          <td>{{ item.perfil }}</td>
          <td>{{ item.cpfcnpj }}</td>
          <td>{{ item.placa }}</td>
          <td>{{ item.get_resultado_display }}</td>
          <td>{{ item.get_periodo_display }}</td>
          <td>
            <a href="{% url 'cadastro_update' item.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center">Nenhum registro encontrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Paginação #}
  {% if is_paginated %}
  <nav aria-label="Navegação de páginas">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.data_inicio %}&data_inicio={{ request.GET.data_inicio }}{% endif %}{% if request.GET.data_fim %}&data_fim={{ request.GET.data_fim }}{% endif %}">« Anterior</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">« Anterior</span></li>
      {% endif %}

      {% for num in paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if request.GET.data_inicio %}&data_inicio={{ request.GET.data_inicio }}{% endif %}{% if request.GET.data_fim %}&data_fim={{ request.GET.data_fim }}{% endif %}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.data_inicio %}&data_inicio={{ request.GET.data_inicio }}{% endif %}{% if request.GET.data_fim %}&data_fim={{ request.GET.data_fim }}{% endif %}">Próximo »</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Próximo »</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

</div>

<!-- Adicionar scripts necessários -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  // Inicializar jsPDF
  const { jsPDF } = window.jspdf;

  function exportToPDF() {
    const element = document.getElementById('table-container');
    const title = 'Relatório de Perfis';
    
    html2canvas(element).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 295; // A4 height in mm
      const imgHeight = canvas.height * imgWidth / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;

      // Adicionar título
      pdf.setFontSize(16);
      pdf.text(title, 20, 20);

      // Adicionar data de exportação
      const today = new Date();
      const dateStr = today.toLocaleDateString('pt-BR');
      pdf.setFontSize(10);
      pdf.text(`Exportado em: ${dateStr}`, 20, 30);

      // Adicionar a tabela
      pdf.addImage(imgData, 'PNG', 0, 40, imgWidth, imgHeight);

      // Adicionar número de páginas
      const pageCount = Math.ceil(heightLeft / pageHeight);
      for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFontSize(10);
        pdf.text(`Página ${i} de ${pageCount}`, 20, pageHeight - 10);
      }

      pdf.save('relatorio_perfis.pdf');
    });
  }
</script>
{% endblock %}
