{% extends 'base.html' %}
{% load static %}
{% load nestle_filters %}

{% block content %}
{% csrf_token %}
<style>
    /* Estilos para garantir texto preto no modal */
    #valorModal .modal-title,
    #valorModal label,
    #valorModal input,
    #valorModal .form-label,
    #valorModal .modal-body,
    #valorModal .modal-footer button {
        color: #111 !important;
    }
    #valorModal input {
        background: #fff;
        color: #111 !important;
    }
    #valorModal .form-check-label {
        color: #111 !important;
    }
    .total-row {
        font-weight: bold;
        background-color: #f8f9fa;
    }
    .equipamento-base {
        background-color: #e9ecef !important;
        position: relative;
    }
    .equipamento-base::after {
        content: "Base";
        position: absolute;
        top: 0;
        right: 0;
        font-size: 0.7em;
        padding: 2px 4px;
        background-color: #6c757d;
        color: white;
        border-radius: 0 0 0 4px;
    }
</style>

<div class="container-fluid py-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Valores Mensais por Cliente</h4>
            <div>
                <select id="ano-select" class="form-select" onchange="window.location.href='?ano=' + this.value">
                    {% for ano in "2025,2024,2023,2022"|split:"," %}
                        <option value="{{ ano }}" {% if ano == ano_atual %}selected{% endif %}>{{ ano }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Cliente</th>
                            {% for mes_codigo, mes_nome in meses %}
                                <th>{{ mes_nome }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for cliente in clientes %}
                            <tr>
                                <td>{{ cliente.cliente }}</td>
                                {% for mes_codigo, mes_nome in meses %}
                                    {% with chave=cliente.id|stringformat:"i"|add:","|add:mes_codigo %}
                                        {% with valor=valores|filter_by_cliente_and_mes:chave %}
                                            <td class="valor-cell {% if valor.enviado %}bg-success bg-opacity-25{% elif not valor.valor %}equipamento-base{% endif %} text-center"
                                                data-cliente-id="{{ cliente.id }}"
                                                data-mes="{{ mes_codigo }}"
                                                data-ano="{{ ano_atual }}"
                                                data-valor="{{ valor.valor|default:'' }}"
                                                data-enviado="{{ valor.enviado|yesno:'true,false' }}"
                                                style="cursor: pointer;"
                                                onclick="abrirModal(this)">
                                                {{ valor.valor|default:'' }}
                                            </td>
                                        {% endwith %}
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td>Total</td>
                            {% for mes_codigo, mes_nome in meses %}
                                <td class="text-center">
                                    {{ valores|total_por_mes:mes_codigo }}
                                </td>
                            {% endfor %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="valorModal" tabindex="-1" aria-labelledby="valorModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="valorModalLabel">Editar Valor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="valorForm">
                    <div class="mb-3">
                        <label class="form-label">Valor</label>
                        <input type="number" class="form-control" id="valorInput" step="1" min="0">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="enviadoCheck">
                        <label class="form-check-label">Enviado</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarValor()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar o modal
    window.modal = new bootstrap.Modal(document.getElementById('valorModal'), {
        keyboard: true,
        focus: true
    });

    // Adicionar evento para quando o modal for fechado
    document.getElementById('valorModal').addEventListener('hidden.bs.modal', function () {
        // Remover foco do botão quando o modal for fechado
        document.activeElement.blur();
    });
});

function abrirModal(celula) {
    window.celulaAtual = celula;
    const valor = celula.dataset.valor || '';
    const enviado = celula.dataset.enviado === 'true';
    
    document.getElementById('valorInput').value = valor;
    document.getElementById('enviadoCheck').checked = enviado;
    
    window.modal.show();
}

function salvarValor() {
    console.log('=== INÍCIO DO DEBUG FRONTEND ===');
    
    const valorInput = document.getElementById('valorInput').value;
    const valor = valorInput ? parseInt(valorInput) : '';
    const enviado = document.getElementById('enviadoCheck').checked;
    const ano = document.getElementById('ano-select').value;
    
    console.log('Dados a serem enviados:');
    console.log('cliente_id:', window.celulaAtual.dataset.clienteId);
    console.log('mes:', window.celulaAtual.dataset.mes);
    console.log('ano:', ano);
    console.log('valor:', valor);
    console.log('enviado:', enviado);
    
    // Criar FormData para enviar os dados
    const formData = new FormData();
    formData.append('cliente_id', window.celulaAtual.dataset.clienteId);
    formData.append('mes', window.celulaAtual.dataset.mes);
    formData.append('ano', ano);
    formData.append('valor', valor);
    formData.append('enviado', enviado);
    
    // Adicionar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    console.log('CSRF Token:', csrfToken);
    
    // Mostrar feedback visual de carregamento
    const salvarBtn = document.querySelector('#valorModal .btn-primary');
    const originalText = salvarBtn.textContent;
    salvarBtn.disabled = true;
    salvarBtn.textContent = 'Salvando...';
    
    console.log('Enviando requisição para o servidor...');
    
    fetch('/nestle/atualizar-valor-mensal/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => {
        console.log('Resposta recebida:', response);
        if (!response.ok) {
            throw new Error('Erro na resposta do servidor');
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados recebidos:', data);
        if (data.success) {
            console.log('Atualizando interface...');
            // Atualizar a célula com os novos dados
            window.celulaAtual.dataset.valor = data.valor;
            window.celulaAtual.dataset.enviado = data.enviado;
            window.celulaAtual.textContent = data.valor ? parseInt(data.valor) : '';
            
            // Atualizar as classes de fundo
            window.celulaAtual.classList.remove('bg-success', 'bg-opacity-25', 'equipamento-base');
            if (data.enviado) {
                window.celulaAtual.classList.add('bg-success', 'bg-opacity-25');
            } else if (!data.valor) {
                window.celulaAtual.classList.add('equipamento-base');
            }
            
            console.log('Interface atualizada com sucesso');
            // Fechar o modal
            window.modal.hide();
        } else {
            throw new Error(data.error || 'Erro ao salvar os dados');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar: ' + error.message);
    })
    .finally(() => {
        // Restaurar o botão
        salvarBtn.disabled = false;
        salvarBtn.textContent = originalText;
        console.log('=== FIM DO DEBUG FRONTEND ===');
    });
}
</script>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %} 