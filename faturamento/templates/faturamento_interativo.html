{% extends 'base.html' %}
{% block title %}| Faturamento Interativo |{% endblock %}

{% include 'components/_header.html' %}
{% block content %}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<style>
    html, body {
        background-color: #45494E;
        color: #f2f4f7;
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
        background-attachment: fixed;
        overflow-y: hidden;
        overflow-x: hidden;
    }

    .container-page {
        width: 100vw;
        max-width: 100vw;
        margin: 0;
        padding: 0;
        position: relative;
        overflow-x: hidden;
    }

    .content-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,.06);
        padding: 1.2rem 1rem;
        margin-bottom: 1.5rem;
        overflow-x: hidden;
        
        
    }

    .table-responsive { 
        overflow-y: auto;
        overflow-x: auto;
        max-height: 60vh;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        position: relative;
    }

    .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               .table {
            margin-bottom: 0;
            width: 100%;
            table-layout: auto;
            min-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

    .table th {
        position: sticky;
        top: 0;
        background: #343a40;
        color: white;
        z-index: 10;
        white-space: nowrap;
        font-size: 0.75rem;
        padding: 0.4rem 0.2rem;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .table td {
        white-space: normal;
        vertical-align: middle;
        font-size: 0.7rem;
        padding: 0.4rem 0.2rem;
        overflow: visible;
        word-wrap: break-word;
        word-break: break-word;
        max-width: 120px;
        min-width: 60px;
        height: auto;
        min-height: 40px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .table td:hover {
        background-color: #f8f9fa;
    }

    .table td.editable {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
    }

    /* Estilos para status de faturamento */
    .status-recebido {
        background-color: #d4edda !important;
        color: #155724 !important;
        font-weight: 600;
        border-radius: 4px;
        padding: 2px 6px;
        display: inline-block;
        min-width: 80px;
        text-align: center;
        border: 1px solid #c3e6cb;
    }

    .status-a-receber {
        background-color: #f8d7da !important;
        color: #721c24 !important;
        font-weight: 600;
        border-radius: 4px;
        padding: 2px 6px;
        display: inline-block;
        min-width: 80px;
        text-align: center;
        border: 1px solid #f5c6cb;
    }

    /* Estilos para linhas com status específico */
    .row-recebido {
        background-color: #f8fff9 !important;
    }

    .row-recebido:hover {
        background-color: #e8f5e8 !important;
    }

    .row-a-receber {
        background-color: #fff8f8 !important;
    }

    .row-a-receber:hover {
        background-color: #ffe8e8 !important;
    }

    .btn-action {
        min-width: 60px;
        margin-right: 0.2rem;
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        height: 24px;
    }

    .btn-add-row {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 18px;
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

    .btn-add-row:hover {
        background: #218838;
        transform: scale(1.1);
    }

    /* Estilos para o botão de adicionar múltiplas linhas */
    .btn-add-multiple {
        position: fixed;
        bottom: 20px;
        left: 80px;
        z-index: 1000;
    }

    .btn-add-multiple .input-group {
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        border-radius: 20px;
        overflow: hidden;
    }

    .btn-add-multiple .form-control {
        border: none;
        background: #f8f9fa;
        text-align: center;
        font-weight: 600;
        color: #495057;
        width: 60px;
        height: 40px;
        font-size: 0.9rem;
    }

    .btn-add-multiple .form-control:focus {
        box-shadow: none;
        background: #e9ecef;
    }

    .btn-add-multiple .btn {
        border: none;
        background: #17a2b8;
        color: white;
        transition: all 0.3s ease;
        height: 40px;
        width: 40px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-add-multiple .btn:hover {
        background: #138496;
        transform: scale(1.05);
    }

    /* Modal Styles */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
        background: #343a40;
        color: white;
        border-radius: 12px 12px 0 0;
        border-bottom: none;
    }

    .modal-body {
        padding: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.3rem;
    }

    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #ced4da;
        font-size: 0.85rem;
        padding: 0.375rem 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .btn-save {
        background: #28a745;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
    }

    .btn-save:hover {
        background: #218838;
    }

    .btn-delete {
        background: #dc3545;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
    }

    .btn-delete:hover {
        background: #c82333;
    }

    .btn-close {
        background: #6c757d;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
    }

    .btn-close:hover {
        background: #5a6268;
    }

    /* Estilos para checkboxes */
    .row-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #007bff;
    }

    .row-checkbox:checked {
        background-color: #007bff;
        border-color: #007bff;
    }

    #selectAllCheckbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #007bff;
    }

    /* Estilos para paginação */
    .pagination-info {
        font-size: 0.85rem;
        color: #007bff;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #007bff;
    }

    .pagination-controls .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .pagination-controls .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-settings {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #007bff;
    }

    .pagination-settings .form-select {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        width: auto;
    }
    
    /* Garantir que todos os textos da paginação sejam azuis */
    .pagination-info span,
    .pagination-controls span,
    .pagination-settings label {
        color: #007bff !important;
    }

    /* Estilos para o modal de confirmação */
    #deleteConfirmModal .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    #deleteConfirmModal .modal-header {
        border-bottom: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px 12px 0 0;
    }

    #deleteConfirmModal .modal-footer {
        border-top: 1px solid #dee2e6;
        border-radius: 0 0 12px 12px;
    }

    #deleteConfirmModal .btn {
        border-radius: 6px;
        font-weight: 500;
        padding: 8px 20px;
    }

    #deleteConfirmModal .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }

    #deleteConfirmModal .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    #deleteConfirmModal .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    #deleteConfirmModal .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

                                                                                                                                                                                                                                                                                                                               /* Responsividade */
       @media (max-width: 768px) {
           .container-page {
               margin-left: -320px !important;
               margin-right: auto !important;
           }
           
           .table th, .table td {
               font-size: 0.65rem;
               padding: 0.3rem 0.15rem;
           }
           
           .btn-action {
               min-width: 50px;
               font-size: 0.6rem;
               padding: 0.15rem 0.3rem;
               height: 22px;
           }
           
           .status-recebido, .status-a-receber {
               font-size: 0.6rem;
               padding: 1px 4px;
               min-width: 60px;
           }
           
           .status-recebido i, .status-a-receber i {
               margin-right: 2px;
           }
           
           .table {
                min-width: 1000px;
                margin-left: -600px;
                margin-right: auto;
            }
       }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   @media (max-width: 576px) {
            .container-page {
                margin-left: -192px !important;
                margin-right: auto !important;
            }
            
            .table th, .table td {
                font-size: 0.6rem;
                padding: 0.2rem 0.1rem;
            }
            
            .btn-action {
                min-width: 45px;
                font-size: 0.55rem;
                padding: 0.1rem 0.25rem;
                height: 20px;
            }
            
            .status-recebido, .status-a-receber {
                font-size: 0.55rem;
                padding: 1px 3px;
                min-width: 50px;
            }
            
            .status-recebido i, .status-a-receber i {
                margin-right: 1px;
            }
            
            .table {
                min-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }
        }
</style>

 <div class="container-page mt-4 mb-5" style="margin-left:-620px; margin-right:auto; padding-left:0; width:99vw; max-width:98vw;">
    <div class="panel mb-3">
        <div class="content-card">
                     
             
             <!-- Filtros -->
             <div class="row mb-3">
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-users"></i></span>
                         <select class="form-select" id="clienteFilter">
                             <option value="">Todos os clientes</option>
                         </select>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                         <select class="form-select" id="comercialFilter">
                             <option value="">Todos os comerciais</option>
                         </select>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-building"></i></span>
                         <select class="form-select" id="nomeFantasiaFilter">
                             <option value="">Todos os nomes fantasia</option>
                         </select>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-cogs"></i></span>
                         <select class="form-select" id="sistemaOmieFilter">
                             <option value="">Todos os sistemas Omie</option>
                         </select>
                     </div>
                 </div>
             </div>
             <div class="row mb-3">
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-industry"></i></span>
                         <select class="form-select" id="empresaFilter">
                             <option value="">Todas as empresas</option>
                         </select>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                         <select class="form-select" id="emailFilter">
                             <option value="">Todos os emails</option>
                         </select>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-credit-card"></i></span>
                         <select class="form-select" id="formaPagamentoFilter">
                             <option value="">Todas as formas de pagamento</option>
                         </select>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                         <select class="form-select" id="tipoDataFilter">
                             <option value="faturamento">Faturamento</option>
                             <option value="emissao">Emissão</option>
                         </select>
                     </div>
                 </div>
             </div>
             <div class="row mb-3">
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
                         <input type="date" class="form-control" id="dataInicioFilter" placeholder="Data Início">
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
                         <input type="date" class="form-control" id="dataFimFilter" placeholder="Data Fim">
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="input-group">
                         <span class="input-group-text"><i class="fas fa-sort"></i></span>
                         <select class="form-select" id="ordenacaoFilter">
                             <option value="faturamento_desc">Data de Faturamento (Mais Recente)</option>
                             <option value="faturamento_asc">Data de Faturamento (Mais Antiga)</option>
                             <option value="emissao_desc">Data de Emissão (Mais Recente)</option>
                             <option value="emissao_asc">Data de Emissão (Mais Antiga)</option>
                             <option value="cliente_asc">Cliente (A-Z)</option>
                             <option value="cliente_desc">Cliente (Z-A)</option>
                             <option value="valor_desc">Valor (Maior)</option>
                             <option value="valor_asc">Valor (Menor)</option>
                             <option value="id_desc">ID (Mais Recente)</option>
                             <option value="id_asc">ID (Mais Antigo)</option>
                         </select>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <div class="d-flex gap-2">
                         <button class="btn btn-outline-primary" type="button" id="btnFiltrar">
                             <i class="fas fa-filter"></i> Filtrar
                         </button>
                         <button class="btn btn-outline-secondary" type="button" id="btnLimparFiltro">
                             <i class="fas fa-times"></i> Limpar Filtros
                         </button>
                         <button class="btn btn-outline-info" type="button" id="btnVerSelecionados" onclick="verLinhasSelecionadas()">
                             <i class="fas fa-check-square"></i> Ver Selecionados
                         </button>
                     </div>
                 </div>
             </div>

            <!-- Tabela Interativa -->
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="faturamentoTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAllCheckbox" title="Selecionar todos">
                            </th>
                            <th>ID</th>
                            <th>Faturamento</th>
                            <th>Emissão</th>
                            <th>Reajustado</th>
                            <th>Reajuste</th>
                            <th>Contrato</th>
                            <th>Tempo</th>
                            <th>Comercial</th>
                            <th>Nº Contrato</th>

                            <th>Sistema Omie</th>
                            <th>Empresa</th>
                            <th>Cliente</th>
                            <th>Nome Fantasia</th>
                            <th>Email</th>
                            <th>Tipo Serviço</th>
                            <th>Descrição</th>
                            <th>Forma Pagamento</th>
                            <th>Vencimento</th>
                            <th>Documento</th>
                            <th>Valor Bruto</th>
                            <th>Coluna 1</th>
                            <th>Valor Líquido</th>
                            <th>Juros</th>
                            <th>Data Pagamento</th>
                            <th>Valor Pago</th>
                            <th>Status</th>
                            <th>Situação</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="faturamentoTbody">
                        <!-- Linhas serão adicionadas dinamicamente -->
                    </tbody>
                </table>
            </div>
            
            <!-- Controles de Paginação -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="pagination-info">
                    <span id="paginationInfo">Mostrando 0 de 0 registros</span>
                </div>
                <div class="pagination-controls">
                    <button class="btn btn-outline-primary btn-sm" id="prevPage" onclick="changePage('prev')" disabled>
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <span class="mx-2" id="pageInfo">Página 1 de 1</span>
                    <button class="btn btn-outline-primary btn-sm" id="nextPage" onclick="changePage('next')" disabled>
                        Próximo <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="pagination-settings">
                    <label for="perPageSelect" class="form-label mb-0">Registros por página:</label>
                    <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="perPageSelect" onchange="changePerPage()">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botão Adicionar Linha -->
<button class="btn-add-row" onclick="addNewRow()" title="Adicionar nova linha">
    <i class="fas fa-plus"></i>
</button>

<!-- Botão Adicionar Múltiplas Linhas -->
<div class="btn-add-multiple">
    <div class="input-group input-group-sm">
        <input type="number" class="form-control" id="quantidadeLinhas" placeholder="Qtd" min="1" max="100" value="1">
        <div class="input-group-append">
            <button class="btn btn-success" onclick="addMultipleRows()">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
    </div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
                         <div class="modal-header">
                 <h5 class="modal-title" id="editModalLabel">Editar Registro de Faturamento</h5>
                 <button type="button" class="close text-white" onclick="closeModal()" aria-label="Close">
                     <span aria-hidden="true">&times;</span>
                 </button>
             </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="row">
                        <!-- Primeira coluna -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Faturamento</label>
                                <input type="date" class="form-control" id="edit_faturamento" name="faturamento">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Emissão</label>
                                <input type="date" class="form-control" id="edit_emissao" name="emissao">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reajustado</label>
                                <select class="form-select" id="edit_reajustado" name="reajustado">
                                    <option value="">Selecione o reajuste</option>
                                    <option value="REAJUSTADO">REAJUSTADO</option>
                                    <option value="RENOVADO">RENOVADO</option>
                                    <option value="*REAJUSTE*">*REAJUSTE*</option>
                                    <option value="OK">OK</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reajuste</label>
                                <input type="date" class="form-control" id="edit_reajuste" name="reajuste">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrato</label>
                                <select class="form-select" id="edit_contrato" name="contrato">
                                    <option value="">Tem contrato?</option>
                                    <option value="SIM">SIM</option>
                                    <option value="NÃO">NÃO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tempo</label>
                                <select class="form-select" id="edit_tempo" name="tempo">
                                    <option value="">Tempo de contrato</option>
                                    <option value="4">4</option>
                                    <option value="6">6</option>
                                    <option value="12">12</option>
                                    <option value="24">24</option>
                                    <option value="36">36</option>
                                    <option value="48">48</option>
                                    <option value="60">60</option>
                                    <option value="72">72</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Comercial</label>
                                <select class="form-select" id="edit_comercial" name="comercial">
                                    <option value="">Selecione o comercial</option>
                                    <option value="Marcio">Marcio</option>
                                    <option value="Cido">Cido</option>
                                    <option value="Daniel">Daniel</option>
                                    <option value="Fabio">Fabio</option>
                                    <option value="Alison">Alison</option>
                                    <option value="Marcia">Marcia</option>
                                    <option value="Mayra">Mayra</option>
                                    <option value="Penha">Penha</option>
                                    <option value="Golden">Golden</option>
                                    <option value="Rubens">Rubens</option>
                                    <option value="Sheyla">Sheyla</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nº Contrato</label>
                                <input type="text" class="form-control" id="edit_n_contrato" name="n_contrato" placeholder="Número do contrato">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Sistema Omie</label>
                                <input type="text" class="form-control" id="edit_sistema_omie" name="sistema_omie" placeholder="Sistema Omie">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Empresa</label>
                                <select class="form-select" id="edit_empresa" name="empresa">
                                    <option value="">Selecione a empresa</option>
                                    <option value="Nife - ita">Nife - ita</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Segunda coluna -->
                        <div class="col-md-6">
                                                                                     <div class="form-group">
                                <label class="form-label">Cliente</label>
                                <input type="text" class="form-control" id="edit_cliente" name="cliente" placeholder="Digite o nome do cliente">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nome Fantasia</label>
                                <input type="text" class="form-control" id="edit_nome_fantasia" name="nome_fantasia" placeholder="Nome fantasia">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="edit_email" name="email" placeholder="Email do cliente">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo Serviço</label>
                                <input type="text" class="form-control" id="edit_tipo_servico" name="tipo_servico" placeholder="Tipo de serviço">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Descrição</label>
                                <textarea class="form-control" id="edit_descricao" name="descricao" rows="3" placeholder="Descrição do serviço"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Forma Pagamento</label>
                                <select class="form-select" id="edit_forma_pagamento" name="forma_pagamento">
                                    <option value="">Forma de pagamento</option>
                                    <option value="Boleto">Boleto</option>
                                    <option value="Transferência">Transferência</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vencimento</label>
                                <input type="date" class="form-control" id="edit_vecimento" name="vecimento">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Documento</label>
                                <select class="form-select" id="edit_documento" name="documento">
                                    <option value="">Tipo de documento</option>
                                    <option value="Recibo">Recibo</option>
                                    <option value="NF">NF</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valor Bruto</label>
                                <input type="number" class="form-control" id="edit_valor_bruto" name="valor_bruto" step="0.01" placeholder="Valor bruto">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Coluna 1</label>
                                <input type="number" class="form-control" id="edit_coluna1" name="coluna1" step="0.01" placeholder="Coluna 1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valor Líquido</label>
                                <input type="number" class="form-control" id="edit_valor_liquido" name="valor_liquido" step="0.01" placeholder="Valor líquido">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Juros</label>
                                <input type="number" class="form-control" id="edit_juros" name="juros" step="0.01" placeholder="Juros">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Pagamento</label>
                                <input type="date" class="form-control" id="edit_data_pgto" name="data_pgto">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valor Pago</label>
                                <input type="number" class="form-control" id="edit_valor_pago" name="valor_pago" step="0.01" placeholder="Valor pago">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="edit_status2" name="status2">
                                    <option value="">Status</option>
                                    <option value="Recebido">Recebido</option>
                                    <option value="A Receber">A Receber</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Situação</label>
                                <select class="form-select" id="edit_situacao" name="situacao">
                                    <option value="">Situação</option>
                                    <option value="OK">OK</option>
                                    <option value="Em dia">Em dia</option>
                                    <option value="Vence em breve">Vence em breve</option>
                                    <option value="Vence Hoje">Vence Hoje</option>
                                    <option value="Vencida">Vencida</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
                                                   <div class="modal-footer">
                  <button type="button" class="btn btn-delete" onclick="deleteRow()">
                      <i class="fas fa-trash"></i> Deletar
                  </button>
                  <button type="button" class="btn btn-save" onclick="saveRow()">
                      <i class="fas fa-save"></i> Salvar
                  </button>
              </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-0 text-dark">
                    <i class="fas fa-question-circle text-warning me-2"></i>
                    Tem certeza que deseja excluir este registro?
                </p>
                <p class="text-dark small mt-2 mb-0">
                    Esta ação não pode ser desfeita.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>
                    Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let currentRowIndex = -1;
let rowCounter = 1;
let currentPage = 1;
let perPage = 50;
let totalPages = 1;
let totalRecords = 0;

// Inicializar a tabela
document.addEventListener('DOMContentLoaded', function() {
    loadClientes();
    loadComerciais();
    loadNomesFantasia();
    loadSistemasOmie();
    loadEmpresas();
    loadEmails();
    loadFormasPagamento();
    loadInitialData();
    setupTableEvents();
    setupRowCheckboxEvents(); // Adicionar eventos para checkboxes
});

function loadClientes() {
    // Carregar lista de clientes
    fetch('/faturamento/get-clientes/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.clientes) {
                const select = document.getElementById('clienteFilter');
                
                // Manter a opção "Todos os clientes"
                select.innerHTML = '<option value="">Todos os clientes</option>';
                
                // Adicionar opções de clientes
                data.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente;
                    option.textContent = cliente;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar clientes:', error);
        });
}

function loadComerciais() {
    // Carregar lista de comerciais
    fetch('/faturamento/get-comerciais/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.comerciais) {
                const select = document.getElementById('comercialFilter');
                
                // Manter a opção "Todos os comerciais"
                select.innerHTML = '<option value="">Todos os comerciais</option>';
                
                // Adicionar opções de comerciais
                data.comerciais.forEach(comercial => {
                    const option = document.createElement('option');
                    option.value = comercial;
                    option.textContent = comercial;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar comerciais:', error);
        });
}

function loadNomesFantasia() {
    // Carregar lista de nomes fantasia
    fetch('/faturamento/get-nomes-fantasia/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.nomes_fantasia) {
                const select = document.getElementById('nomeFantasiaFilter');
                
                // Manter a opção "Todos os nomes fantasia"
                select.innerHTML = '<option value="">Todos os nomes fantasia</option>';
                
                // Adicionar opções de nomes fantasia
                data.nomes_fantasia.forEach(nome => {
                    const option = document.createElement('option');
                    option.value = nome;
                    option.textContent = nome;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar nomes fantasia:', error);
        });
}

function loadSistemasOmie() {
    // Carregar lista de sistemas Omie
    fetch('/faturamento/get-sistemas-omie/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.sistemas_omie) {
                const select = document.getElementById('sistemaOmieFilter');
                
                // Manter a opção "Todos os sistemas Omie"
                select.innerHTML = '<option value="">Todos os sistemas Omie</option>';
                
                // Adicionar opções de sistemas Omie
                data.sistemas_omie.forEach(sistema => {
                    const option = document.createElement('option');
                    option.value = sistema;
                    option.textContent = sistema;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar sistemas Omie:', error);
        });
}

function loadEmpresas() {
    // Carregar lista de empresas
    fetch('/faturamento/get-empresas/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.empresas) {
                const select = document.getElementById('empresaFilter');
                
                // Manter a opção "Todas as empresas"
                select.innerHTML = '<option value="">Todas as empresas</option>';
                
                // Adicionar opções de empresas
                data.empresas.forEach(empresa => {
                    const option = document.createElement('option');
                    option.value = empresa;
                    option.textContent = empresa;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar empresas:', error);
        });
}

function loadEmails() {
    // Carregar lista de emails
    fetch('/faturamento/get-emails/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.emails) {
                const select = document.getElementById('emailFilter');
                
                // Manter a opção "Todos os emails"
                select.innerHTML = '<option value="">Todos os emails</option>';
                
                // Adicionar opções de emails
                data.emails.forEach(email => {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = email;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar emails:', error);
        });
}

function loadFormasPagamento() {
    // Carregar lista de formas de pagamento
    fetch('/faturamento/get-formas-pagamento/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.formas_pagamento) {
                const select = document.getElementById('formaPagamentoFilter');
                
                // Manter a opção "Todas as formas de pagamento"
                select.innerHTML = '<option value="">Todas as formas de pagamento</option>';
                
                // Adicionar opções de formas de pagamento
                data.formas_pagamento.forEach(forma => {
                    const option = document.createElement('option');
                    option.value = forma;
                    option.textContent = forma;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar formas de pagamento:', error);
        });
}

function loadInitialData() {
    loadDataForPage(1);
}

function loadDataForPage(page) {
    // Obter filtros
    const clienteFilter = document.getElementById('clienteFilter').value.trim();
    const comercialFilter = document.getElementById('comercialFilter').value.trim();
    const nomeFantasiaFilter = document.getElementById('nomeFantasiaFilter').value.trim();
    const sistemaOmieFilter = document.getElementById('sistemaOmieFilter').value.trim();
    const empresaFilter = document.getElementById('empresaFilter').value.trim();
    const emailFilter = document.getElementById('emailFilter').value.trim();
    const formaPagamentoFilter = document.getElementById('formaPagamentoFilter').value.trim();
    const dataInicioFilter = document.getElementById('dataInicioFilter').value.trim();
    const dataFimFilter = document.getElementById('dataFimFilter').value.trim();
    const tipoDataFilter = document.getElementById('tipoDataFilter').value.trim();
    const ordenacaoFilter = document.getElementById('ordenacaoFilter').value.trim();
    
    // Carregar dados do banco de dados via AJAX com paginação e filtros
    let url = `/faturamento/get-data/?page=${page}&per_page=${perPage}`;
    if (clienteFilter) {
        url += `&cliente=${encodeURIComponent(clienteFilter)}`;
    }
    if (comercialFilter) {
        url += `&comercial=${encodeURIComponent(comercialFilter)}`;
    }
    if (nomeFantasiaFilter) {
        url += `&nome_fantasia=${encodeURIComponent(nomeFantasiaFilter)}`;
    }
    if (sistemaOmieFilter) {
        url += `&sistema_omie=${encodeURIComponent(sistemaOmieFilter)}`;
    }
    if (empresaFilter) {
        url += `&empresa=${encodeURIComponent(empresaFilter)}`;
    }
    if (emailFilter) {
        url += `&email=${encodeURIComponent(emailFilter)}`;
    }
    if (formaPagamentoFilter) {
        url += `&forma_pagamento=${encodeURIComponent(formaPagamentoFilter)}`;
    }
    if (dataInicioFilter && dataFimFilter) {
        url += `&data_inicio=${encodeURIComponent(dataInicioFilter)}`;
        url += `&data_fim=${encodeURIComponent(dataFimFilter)}`;
        url += `&tipo_data=${encodeURIComponent(tipoDataFilter)}`;
    }
    
    // Adicionar parâmetro de ordenação
    if (ordenacaoFilter) {
        url += `&ordenacao=${encodeURIComponent(ordenacaoFilter)}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.faturamentos) {
                // Limpar tabela atual
                document.getElementById('faturamentoTbody').innerHTML = '';
                
                // Limpar checkboxes selecionados
                clearAllCheckboxes();
                
                // Adicionar dados da página atual
                data.faturamentos.forEach(faturamento => {
                    const rowData = {
                        id: faturamento.id,
                        faturamento: faturamento.faturamento || '',
                        emissao: faturamento.emissao || '',
                        reajustado: faturamento.reajustado || '',
                        reajuste: faturamento.reajuste || '',
                        contrato: faturamento.contrato || '',
                        tempo: faturamento.tempo || '',
                        comercial: faturamento.comercial || '',
                        n_contrato: faturamento.n_contrato || '',
                        sistema_omie: faturamento.sistema_omie || '',
                        empresa: faturamento.empresa || '',
                        cliente: faturamento.cliente || '',
                        nome_fantasia: faturamento.nome_fantasia || '',
                        email: faturamento.email || '',
                        tipo_servico: faturamento.tipo_servico || '',
                        descricao: faturamento.descricao || '',
                        forma_pagamento: faturamento.forma_pagamento || '',
                        vecimento: faturamento.vecimento || '',
                        documento: faturamento.documento || '',
                        valor_bruto: faturamento.valor_bruto || '',
                        coluna1: faturamento.coluna1 || '',
                        valor_liquido: faturamento.valor_liquido || '',
                        juros: faturamento.juros || '',
                        data_pgto: faturamento.data_pgto || '',
                        valor_pago: faturamento.valor_pago || '',
                        status2: faturamento.status2 || '',
                        situacao: faturamento.situacao || ''
                    };
                    addRowToTable(rowData);
                });
                
                // Atualizar informações de paginação
                if (data.pagination) {
                    updatePaginationInfo(data.pagination);
                }
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados:', error);
        });
}

function updatePaginationInfo(pagination) {
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    totalRecords = pagination.total_records;
    
    // Atualizar informações de paginação
    document.getElementById('paginationInfo').textContent = 
        `Mostrando ${pagination.per_page} de ${pagination.total_records} registros`;
    
    document.getElementById('pageInfo').textContent = 
        `Página ${pagination.current_page} de ${pagination.total_pages}`;
    
    // Atualizar botões
    document.getElementById('prevPage').disabled = !pagination.has_previous;
    document.getElementById('nextPage').disabled = !pagination.has_next;
}

function changePage(direction) {
    let newPage = currentPage;
    
    if (direction === 'prev' && currentPage > 1) {
        newPage = currentPage - 1;
    } else if (direction === 'next' && currentPage < totalPages) {
        newPage = currentPage + 1;
    }
    
    if (newPage !== currentPage) {
        loadDataForPage(newPage);
    }
}

function changePerPage() {
    perPage = parseInt(document.getElementById('perPageSelect').value);
    loadDataForPage(1); // Voltar para a primeira página
}

function addNewRow() {
    // Verificar se há linhas selecionadas
    const selectedRows = getSelectedRows();
    let baseData = null;
    
    if (selectedRows.length > 0) {
        // Usar a primeira linha selecionada como base
        const firstSelectedRow = document.querySelector(`tr[data-row-id="${selectedRows[0]}"]`);
        if (firstSelectedRow) {
            baseData = getRowData(firstSelectedRow);
            // Mostrar mensagem informativa
            showToast(`Copiando dados da linha ${selectedRows[0]} como base para nova linha`, 'info');
        }
    }
    
    // Primeiro obter o próximo ID disponível do servidor
    getNextAvailableId(function(nextId) {
        const newData = {
            id: nextId,
        faturamento: baseData ? baseData.faturamento : '',
        emissao: baseData ? baseData.emissao : '',
        reajustado: baseData ? baseData.reajustado : '',
        reajuste: baseData ? baseData.reajuste : '',
        contrato: baseData ? baseData.contrato : '',
        tempo: baseData ? baseData.tempo : '',
        comercial: baseData ? baseData.comercial : '',
        n_contrato: baseData ? baseData.n_contrato : '',
        sistema_omie: baseData ? baseData.sistema_omie : '',
        empresa: baseData ? baseData.empresa : '',
        cliente: baseData ? baseData.cliente : '',
        nome_fantasia: baseData ? baseData.nome_fantasia : '',
        email: baseData ? baseData.email : '',
        tipo_servico: baseData ? baseData.tipo_servico : '',
        descricao: baseData ? baseData.descricao : '',
        forma_pagamento: baseData ? baseData.forma_pagamento : '',
        vecimento: baseData ? baseData.vecimento : '',
        documento: baseData ? baseData.documento : '',
        valor_bruto: baseData ? baseData.valor_bruto : '',
        coluna1: baseData ? baseData.coluna1 : '',
        valor_liquido: baseData ? baseData.valor_liquido : '',
        juros: baseData ? baseData.juros : '',
        data_pgto: baseData ? baseData.data_pgto : '',
        valor_pago: baseData ? baseData.valor_pago : '',
        status2: baseData ? baseData.status2 : '',
        situacao: baseData ? baseData.situacao : ''
    };
    
    // Adicionar à tabela primeiro
    addRowToTable(newData, true);
    
    // Salvar automaticamente no servidor
    saveToServer(newData.id, newData, function(success) {
        if (success) {
            showToast('Nova linha criada e salva com sucesso!', 'success');
        } else {
            showToast('Linha criada mas houve erro ao salvar no servidor', 'warning');
        }
    });
    
        // Se havia linhas selecionadas, desmarcar todas após criar a nova linha
        if (selectedRows.length > 0) {
            clearAllCheckboxes();
        }
    });
}

function addMultipleRows() {
    const quantidade = parseInt(document.getElementById('quantidadeLinhas').value);
    if (isNaN(quantidade) || quantidade < 1 || quantidade > 100) {
        showToast('Por favor, insira um número entre 1 e 100.', 'warning');
        return;
    }

    // Verificar se há linhas selecionadas
    const selectedRows = getSelectedRows();
    let baseData = null;
    
    if (selectedRows.length > 0) {
        // Usar a primeira linha selecionada como base
        const firstSelectedRow = document.querySelector(`tr[data-row-id="${selectedRows[0]}"]`);
        if (firstSelectedRow) {
            baseData = getRowData(firstSelectedRow);
            showToast(`Copiando dados da linha ${selectedRows[0]} como base para ${quantidade} novas linhas`, 'info');
        }
    }

    // Obter múltiplos IDs disponíveis
    getMultipleAvailableIds(quantidade, function(availableIds) {
        let linhasCriadas = 0;
        let linhasSalvas = 0;

        for (let i = 0; i < quantidade; i++) {
            const newData = {
                id: availableIds[i],
            faturamento: baseData ? baseData.faturamento : '',
            emissao: baseData ? baseData.emissao : '',
            reajustado: baseData ? baseData.reajustado : '',
            reajuste: baseData ? baseData.reajuste : '',
            contrato: baseData ? baseData.contrato : '',
            tempo: baseData ? baseData.tempo : '',
            comercial: baseData ? baseData.comercial : '',
            n_contrato: baseData ? baseData.n_contrato : '',
            sistema_omie: baseData ? baseData.sistema_omie : '',
            empresa: baseData ? baseData.empresa : '',
            cliente: baseData ? baseData.cliente : '',
            nome_fantasia: baseData ? baseData.nome_fantasia : '',
            email: baseData ? baseData.email : '',
            tipo_servico: baseData ? baseData.tipo_servico : '',
            descricao: baseData ? baseData.descricao : '',
            forma_pagamento: baseData ? baseData.forma_pagamento : '',
            vecimento: baseData ? baseData.vecimento : '',
            documento: baseData ? baseData.documento : '',
            valor_bruto: baseData ? baseData.valor_bruto : '',
            coluna1: baseData ? baseData.coluna1 : '',
            valor_liquido: baseData ? baseData.valor_liquido : '',
            juros: baseData ? baseData.juros : '',
            data_pgto: baseData ? baseData.data_pgto : '',
            valor_pago: baseData ? baseData.valor_pago : '',
            status2: baseData ? baseData.status2 : '',
            situacao: baseData ? baseData.situacao : ''
        };
        
        // Adicionar à tabela
        addRowToTable(newData, true);
        linhasCriadas++;
        
        // Salvar automaticamente no servidor
        saveToServer(newData.id, newData, function(success) {
            if (success) {
                linhasSalvas++;
                if (linhasSalvas === quantidade) {
                    showToast(`${linhasCriadas} linhas criadas e ${linhasSalvas} salvas com sucesso!`, 'success');
                }
            } else {
                showToast(`Erro ao salvar linha ${newData.id}`, 'error');
            }
        });
    }
    
    // Se havia linhas selecionadas, desmarcar todas após criar as novas linhas
    if (selectedRows.length > 0) {
        clearAllCheckboxes();
    }
    
        showToast(`${quantidade} linhas sendo criadas e salvas...`, 'info');
    });
}

// Função auxiliar para extrair dados de uma linha
function getRowData(row) {
    const fields = [
        'faturamento', 'emissao', 'reajustado', 'reajuste', 'contrato', 'tempo',
        'comercial', 'n_contrato', 'sistema_omie', 'empresa',
        'cliente', 'nome_fantasia', 'email', 'tipo_servico', 'descricao',
        'forma_pagamento', 'vecimento', 'documento', 'valor_bruto', 'coluna1',
        'valor_liquido', 'juros', 'data_pgto', 'valor_pago', 'status2', 'situacao'
    ];
    
    const rowData = {};
    fields.forEach(field => {
        const cell = row.querySelector(`td[data-field="${field}"]`);
        if (cell) {
            // Para campos de status, extrair apenas o texto sem as tags HTML
            if (field === 'status2') {
                const statusSpan = cell.querySelector('.status-recebido, .status-a-receber');
                rowData[field] = statusSpan ? statusSpan.textContent.trim() : (cell.dataset.value || cell.textContent || '');
            } else {
                rowData[field] = cell.dataset.value || cell.textContent || '';
            }
        }
    });
    
    return rowData;
}

function addRowToTable(data, isNew = false) {
    const tbody = document.getElementById('faturamentoTbody');
    const row = document.createElement('tr');
    row.dataset.rowId = data.id;
    
    // Aplicar classes de cor baseadas no status
    if (data.status2 === 'Recebido') {
        row.classList.add('row-recebido');
    } else if (data.status2 === 'A Receber') {
        row.classList.add('row-a-receber');
    }
    
    if (isNew) {
        row.classList.add('new-row');
        tbody.insertBefore(row, tbody.firstChild); // Inserir no topo
    } else {
        tbody.appendChild(row);
    }
    
    // Adicionar célula do checkbox primeiro
    const checkboxCell = document.createElement('td');
    checkboxCell.style.width = '50px';
    checkboxCell.style.textAlign = 'center';
    checkboxCell.innerHTML = `<input type="checkbox" class="row-checkbox" data-row-id="${data.id}">`;
    row.appendChild(checkboxCell);
    
    const fields = [
        'id', 'faturamento', 'emissao', 'reajustado', 'reajuste', 'contrato', 'tempo',
        'comercial', 'n_contrato', 'sistema_omie', 'empresa',
        'cliente', 'nome_fantasia', 'email', 'tipo_servico', 'descricao',
        'forma_pagamento', 'vecimento', 'documento', 'valor_bruto', 'coluna1',
        'valor_liquido', 'juros', 'data_pgto', 'valor_pago', 'status2', 'situacao'
    ];
    
    fields.forEach(field => {
        const cell = document.createElement('td');
        cell.dataset.field = field;
        cell.dataset.value = data[field] || '';
        
        if (field === 'id') {
            cell.textContent = data[field];
        } else if (field === 'cliente') {
            // Para o campo cliente, mostrar o nome diretamente
            cell.textContent = data[field] || '';
            cell.classList.add('editable');
        } else if (field === 'status2') {
            // Para o campo status2, aplicar estilos específicos
            const statusValue = data[field] || '';
            if (statusValue === 'Recebido') {
                cell.innerHTML = `<span class="status-recebido"><i class="fas fa-check-circle me-1"></i>${statusValue}</span>`;
            } else if (statusValue === 'A Receber') {
                cell.innerHTML = `<span class="status-a-receber"><i class="fas fa-clock me-1"></i>${statusValue}</span>`;
            } else {
                cell.textContent = statusValue;
            }
            cell.classList.add('editable');
        } else {
            cell.textContent = data[field] || '';
            cell.classList.add('editable');
        }
        
        row.appendChild(cell);
    });
    
    // Adicionar coluna de ações
    const actionsCell = document.createElement('td');
    actionsCell.className = 'text-center';
    actionsCell.innerHTML = `
        <button class="btn btn-primary btn-action" onclick="editRow(${data.id})" title="Editar">
            <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-danger btn-action" onclick="deleteRowById(${data.id})" title="Deletar">
            <i class="fas fa-trash"></i>
        </button>
    `;
    row.appendChild(actionsCell);
}

function setupTableEvents() {
    const tbody = document.getElementById('faturamentoTbody');
    
    tbody.addEventListener('click', function(e) {
        if (e.target.tagName === 'TD' && e.target.classList.contains('editable')) {
            const row = e.target.parentElement;
            const rowId = row.dataset.rowId;
            editRow(rowId);
        }
    });
    
    // Adicionar evento para o checkbox "selecionar todos"
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });
    }
}

// Função para obter todas as linhas selecionadas
function getSelectedRows() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    const selectedRows = [];
    
    selectedCheckboxes.forEach(checkbox => {
        const rowId = checkbox.dataset.rowId;
        selectedRows.push(rowId);
    });
    
    return selectedRows;
}

// Função para verificar se todas as linhas estão selecionadas
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    
    if (rowCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCheckboxes.length === rowCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// Função para adicionar eventos aos checkboxes das linhas
function setupRowCheckboxEvents() {
    const tbody = document.getElementById('faturamentoTbody');
    
    tbody.addEventListener('change', function(e) {
        if (e.target.classList.contains('row-checkbox')) {
            updateSelectAllCheckbox();
        }
    });
}

 function editRow(rowId) {
     currentRowIndex = rowId;
     const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
     
     if (!row) {
         console.error('Linha não encontrada:', rowId);
         return;
     }
     
     console.log('Editando linha:', rowId);
     
     // Preencher o modal com os dados da linha
     const fields = [
         'faturamento', 'emissao', 'reajustado', 'reajuste', 'contrato', 'tempo',
         'comercial', 'n_contrato', 'sistema_omie', 'empresa',
         'cliente', 'nome_fantasia', 'email', 'tipo_servico', 'descricao',
         'forma_pagamento', 'vecimento', 'documento', 'valor_bruto', 'coluna1',
         'valor_liquido', 'juros', 'data_pgto', 'valor_pago', 'status2', 'situacao'
     ];
     
     fields.forEach(field => {
         const cell = row.querySelector(`td[data-field="${field}"]`);
         const input = document.getElementById(`edit_${field}`);
         
         if (input && cell) {
             const value = cell.dataset.value || cell.textContent || '';
             console.log(`Campo ${field}:`, value);
             
             if (input.type === 'date') {
                 input.value = value;
             } else if (input.type === 'number') {
                 input.value = value;
             } else if (input.tagName === 'SELECT') {
                 input.value = value;
             } else if (input.tagName === 'TEXTAREA') {
                 input.value = value;
             } else {
                 input.value = value;
             }
         } else {
             console.warn(`Campo não encontrado: ${field}`, { input: !!input, cell: !!cell });
         }
     });
     
           // Mostrar o modal
      const modal = document.getElementById('editModal');
      if (modal) {
          modal.classList.add('show');
          modal.style.display = 'block';
          document.body.classList.add('modal-open');
          
          // Adicionar backdrop
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          backdrop.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background-color: rgba(0, 0, 0, 0.5);
              z-index: 1040;
          `;
          document.body.appendChild(backdrop);
          
          console.log('Modal aberto com sucesso');
      } else {
          console.error('Modal não encontrado');
      }
 }

 function saveRow() {
     if (currentRowIndex === -1) {
         console.error('Nenhuma linha selecionada para edição');
         return;
     }
     
     const row = document.querySelector(`tr[data-row-id="${currentRowIndex}"]`);
     if (!row) {
         console.error('Linha não encontrada para salvar:', currentRowIndex);
         return;
     }
     
     console.log('Salvando linha:', currentRowIndex);
     
     // Coletar dados do formulário
     const formData = new FormData(document.getElementById('editForm'));
     const data = {};
     
     for (let [key, value] of formData.entries()) {
         data[key] = value;
         console.log(`Campo ${key}:`, value);
     }
     
     // Atualizar as células da tabela
     Object.keys(data).forEach(field => {
         const cell = row.querySelector(`td[data-field="${field}"]`);
         if (cell) {
             const value = data[field] || '';
             
             // Aplicar estilos específicos para o campo status2
             if (field === 'status2') {
                 if (value === 'Recebido') {
                     cell.innerHTML = `<span class="status-recebido"><i class="fas fa-check-circle me-1"></i>${value}</span>`;
                 } else if (value === 'A Receber') {
                     cell.innerHTML = `<span class="status-a-receber"><i class="fas fa-clock me-1"></i>${value}</span>`;
                 } else {
                     cell.textContent = value;
                 }
             } else {
                 cell.textContent = value;
             }
             
             cell.dataset.value = value;
             console.log(`Atualizando célula ${field}:`, value);
         } else {
             console.warn(`Célula não encontrada: ${field}`);
         }
     });
     
     // Atualizar classes da linha baseadas no novo status
     row.classList.remove('row-recebido', 'row-a-receber');
     if (data.status2 === 'Recebido') {
         row.classList.add('row-recebido');
     } else if (data.status2 === 'A Receber') {
         row.classList.add('row-a-receber');
     }
     
           // Salvar no servidor (AJAX)
      saveToServer(currentRowIndex, data);
      
      // Fechar o modal
      closeModal();
      
      // Feedback visual
      showToast('Registro salvo com sucesso!', 'success');
 }

function deleteRow() {
    if (currentRowIndex === -1) return;
    
    // Mostrar modal de confirmação
    showDeleteConfirmModal(currentRowIndex);
}

function showDeleteConfirmModal(rowId) {
    // Armazenar o ID da linha para exclusão
    document.getElementById('deleteConfirmModal').dataset.rowId = rowId;
    
    // Mostrar o modal usando Bootstrap 4
    $('#deleteConfirmModal').modal('show');
}

function confirmDelete() {
    const rowId = document.getElementById('deleteConfirmModal').dataset.rowId;
    
    if (rowId) {
        const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
        if (row) {
            row.remove();
            deleteFromServer(rowId);
            showToast('Registro deletado com sucesso!', 'success');
        }
        
        // Fechar modal usando Bootstrap 4
        $('#deleteConfirmModal').modal('hide');
        
        // Se estava editando, fechar modal de edição também
        if (currentRowIndex === parseInt(rowId)) {
            closeModal();
        }
    }
}

function deleteRowById(rowId) {
    // Mostrar modal de confirmação
    showDeleteConfirmModal(rowId);
}

function saveToServer(rowId, data, callback) {
    // Implementar AJAX para salvar no servidor
    fetch('/faturamento/save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            row_id: parseInt(rowId) || null, // Converter para inteiro ou null
            data: data
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log('Dados salvos com sucesso');
            // Atualizar o ID da linha se for um novo registro
            if (result.id && rowId !== result.id) {
                const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
                if (row) {
                    row.dataset.rowId = result.id;
                    const idCell = row.querySelector('td[data-field="id"]');
                    if (idCell) {
                        idCell.textContent = result.id;
                        idCell.dataset.value = result.id;
                    }
                }
            }
        } else {
            console.error('Erro ao salvar:', result.error);
            showToast('Erro ao salvar dados!', 'error');
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        showToast('Erro na comunicação com o servidor!', 'error');
    });
}

function deleteFromServer(rowId) {
    // Implementar AJAX para deletar no servidor
    fetch('/faturamento/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            row_id: parseInt(rowId) || null // Converter para inteiro ou null
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log('Registro deletado com sucesso');
        } else {
            console.error('Erro ao deletar:', result.error);
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

 function showToast(message, type = 'info') {
     const toast = document.createElement('div');
     toast.className = `toast toast-${type}`;
     toast.style.cssText = `
         position: fixed;
         top: 20px;
         right: 20px;
         background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
         color: white;
         padding: 1rem 1.5rem;
         border-radius: 6px;
         box-shadow: 0 4px 12px rgba(0,0,0,0.15);
         z-index: 9999;
         font-weight: 600;
     `;
     toast.textContent = message;
     
     document.body.appendChild(toast);
     
     setTimeout(() => {
         toast.remove();
     }, 3000);
 }



  function closeModal() {
      console.log('Fechando modal...');
      const modal = document.getElementById('editModal');
      if (modal) {
          // Remover classes do Bootstrap
          modal.classList.remove('show');
          modal.style.display = 'none';
          document.body.classList.remove('modal-open');
          
          // Remover backdrop se existir
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
              backdrop.remove();
          }
          
          // Resetar índice atual
          currentRowIndex = -1;
          
          console.log('Modal fechado com sucesso');
      } else {
          console.error('Modal não encontrado');
      }
  }

  // Adicionar evento para fechar modal com ESC
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
          closeModal();
      }
  });

  // Adicionar evento para fechar modal clicando fora
  document.addEventListener('click', function(e) {
      const modal = document.getElementById('editModal');
      if (e.target === modal) {
          closeModal();
      }
  });

  // Adicionar evento para o botão de confirmar exclusão
  document.addEventListener('DOMContentLoaded', function() {
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      if (confirmDeleteBtn) {
          confirmDeleteBtn.addEventListener('click', confirmDelete);
      }
      
      // Adicionar evento para fechar modal de exclusão clicando fora
      $('#deleteConfirmModal').on('click', function(e) {
          if (e.target === this) {
              $(this).modal('hide');
          }
      });
      
      // Adicionar eventos para filtros
      const btnFiltrar = document.getElementById('btnFiltrar');
      const btnLimparFiltro = document.getElementById('btnLimparFiltro');
      const clienteFilter = document.getElementById('clienteFilter');
      const comercialFilter = document.getElementById('comercialFilter');
      const nomeFantasiaFilter = document.getElementById('nomeFantasiaFilter');
      const sistemaOmieFilter = document.getElementById('sistemaOmieFilter');
      const empresaFilter = document.getElementById('empresaFilter');
      const emailFilter = document.getElementById('emailFilter');
      const formaPagamentoFilter = document.getElementById('formaPagamentoFilter');
      const dataInicioFilter = document.getElementById('dataInicioFilter');
      const dataFimFilter = document.getElementById('dataFimFilter');
      const tipoDataFilter = document.getElementById('tipoDataFilter');
      
      if (btnFiltrar) {
          btnFiltrar.addEventListener('click', aplicarFiltro);
      }
      
      if (btnLimparFiltro) {
          btnLimparFiltro.addEventListener('click', limparFiltro);
      }
      
      if (clienteFilter) {
          clienteFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (comercialFilter) {
          comercialFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (nomeFantasiaFilter) {
          nomeFantasiaFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (sistemaOmieFilter) {
          sistemaOmieFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (empresaFilter) {
          empresaFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (emailFilter) {
          emailFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (formaPagamentoFilter) {
          formaPagamentoFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (dataInicioFilter) {
          dataInicioFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (dataFimFilter) {
          dataFimFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      if (tipoDataFilter) {
          tipoDataFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
      
      const ordenacaoFilter = document.getElementById('ordenacaoFilter');
      if (ordenacaoFilter) {
          ordenacaoFilter.addEventListener('change', function() {
              aplicarFiltro();
          });
      }
  });
  
  // Função para aplicar filtro
  function aplicarFiltro() {
      currentPage = 1; // Voltar para a primeira página
      loadDataForPage(1);
  }
  
  // Função para limpar filtro
  function limparFiltro() {
      document.getElementById('clienteFilter').value = '';
      document.getElementById('comercialFilter').value = '';
      document.getElementById('nomeFantasiaFilter').value = '';
      document.getElementById('sistemaOmieFilter').value = '';
      document.getElementById('empresaFilter').value = '';
      document.getElementById('emailFilter').value = '';
      document.getElementById('formaPagamentoFilter').value = '';
      document.getElementById('dataInicioFilter').value = '';
      document.getElementById('dataFimFilter').value = '';
      document.getElementById('tipoDataFilter').value = 'faturamento';
      document.getElementById('ordenacaoFilter').value = 'faturamento_desc';
      currentPage = 1; // Voltar para a primeira página
      loadDataForPage(1);
  }

// Função para limpar todos os checkboxes
function clearAllCheckboxes() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    rowCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

// Função para ver detalhes das linhas selecionadas
function verLinhasSelecionadas() {
    const selectedRows = getSelectedRows();
    if (selectedRows.length === 0) {
        showToast('Nenhuma linha selecionada para exibir detalhes.', 'info');
        return;
    }

    const selectedRowsHtml = selectedRows.map(rowId => {
        const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
        if (!row) return `Linha com ID ${rowId} não encontrada.`;

        const fields = [
            'id', 'faturamento', 'emissao', 'reajustado', 'reajuste', 'contrato', 'tempo',
            'comercial', 'n_contrato', 'sistema_omie', 'empresa',
            'cliente', 'nome_fantasia', 'email', 'tipo_servico', 'descricao',
            'forma_pagamento', 'vecimento', 'documento', 'valor_bruto', 'coluna1',
            'valor_liquido', 'juros', 'data_pgto', 'valor_pago', 'status2', 'situacao'
        ];

        const rowData = {};
        fields.forEach(field => {
            const cell = row.querySelector(`td[data-field="${field}"]`);
            rowData[field] = cell ? cell.textContent : 'N/A';
        });

        return `
            <div class="card mb-2">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Detalhes da Linha Selecionada</h6>
                </div>
                <div class="card-body">
                    <p><strong>ID:</strong> ${rowData.id}</p>
                    <p><strong>Faturamento:</strong> ${rowData.faturamento}</p>
                    <p><strong>Emissão:</strong> ${rowData.emissao}</p>
                    <p><strong>Reajustado:</strong> ${rowData.reajustado}</p>
                    <p><strong>Reajuste:</strong> ${rowData.reajuste}</p>
                    <p><strong>Contrato:</strong> ${rowData.contrato}</p>
                    <p><strong>Tempo:</strong> ${rowData.tempo}</p>
                    <p><strong>Comercial:</strong> ${rowData.comercial}</p>
                    <p><strong>Nº Contrato:</strong> ${rowData.n_contrato}</p>
                    <p><strong>Sistema Omie:</strong> ${rowData.sistema_omie}</p>
                    <p><strong>Empresa:</strong> ${rowData.empresa}</p>
                    <p><strong>Cliente:</strong> ${rowData.cliente}</p>
                    <p><strong>Nome Fantasia:</strong> ${rowData.nome_fantasia}</p>
                    <p><strong>Email:</strong> ${rowData.email}</p>
                    <p><strong>Tipo Serviço:</strong> ${rowData.tipo_servico}</p>
                    <p><strong>Descrição:</strong> ${rowData.descricao}</p>
                    <p><strong>Forma Pagamento:</strong> ${rowData.forma_pagamento}</p>
                    <p><strong>Vencimento:</strong> ${rowData.vecimento}</p>
                    <p><strong>Documento:</strong> ${rowData.documento}</p>
                    <p><strong>Valor Bruto:</strong> ${rowData.valor_bruto}</p>
                    <p><strong>Coluna 1:</strong> ${rowData.coluna1}</p>
                    <p><strong>Valor Líquido:</strong> ${rowData.valor_liquido}</p>
                    <p><strong>Juros:</strong> ${rowData.juros}</p>
                    <p><strong>Data Pagamento:</strong> ${rowData.data_pgto}</p>
                    <p><strong>Valor Pago:</strong> ${rowData.valor_pago}</p>
                    <p><strong>Status:</strong> ${rowData.status2}</p>
                    <p><strong>Situação:</strong> ${rowData.situacao}</p>
                </div>
            </div>
        `;
    }).join('');

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'detalhesModal';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-labelledby', 'detalhesModalLabel');
    modal.setAttribute('aria-hidden', 'true');
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="detalhesModalLabel">Detalhes das Linhas Selecionadas</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ${selectedRowsHtml}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    $('#detalhesModal').modal('show');
}

// Função para obter o próximo ID disponível do servidor
// REQUER IMPLEMENTAÇÃO NO BACKEND DJANGO:
// URL: /faturamento/get-next-id/
// View deve retornar: {"success": true, "next_id": 123}
function getNextAvailableId(callback) {
    fetch('/faturamento/get-next-id/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success && result.next_id) {
            callback(result.next_id);
        } else {
            // Fallback: usar contador local se não conseguir obter do servidor
            console.warn('Não foi possível obter ID do servidor, usando contador local');
            callback(rowCounter++);
        }
    })
    .catch(error => {
        console.error('Erro ao obter próximo ID:', error);
        // Fallback: usar contador local se houver erro
        callback(rowCounter++);
    });
}

// Função para obter múltiplos IDs disponíveis do servidor
// REQUER IMPLEMENTAÇÃO NO BACKEND DJANGO:
// URL: /faturamento/get-multiple-ids/?count=5
// View deve retornar: {"success": true, "ids": [123, 124, 125, 126, 127]}
function getMultipleAvailableIds(quantidade, callback) {
    fetch(`/faturamento/get-multiple-ids/?count=${quantidade}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success && result.ids && result.ids.length === quantidade) {
            callback(result.ids);
        } else {
            // Fallback: gerar IDs locais se não conseguir obter do servidor
            console.warn('Não foi possível obter IDs do servidor, gerando IDs locais');
            const localIds = [];
            for (let i = 0; i < quantidade; i++) {
                localIds.push(rowCounter++);
            }
            callback(localIds);
        }
    })
    .catch(error => {
        console.error('Erro ao obter múltiplos IDs:', error);
        // Fallback: gerar IDs locais se houver erro
        const localIds = [];
        for (let i = 0; i < quantidade; i++) {
            localIds.push(rowCounter++);
        }
        callback(localIds);
    });
}
</script>
{% endblock %}
