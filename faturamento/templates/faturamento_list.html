{% extends 'base.html' %}
{% block title %}| Faturamento |{% endblock %}

{% include 'components/_header.html' %}
{% block content %}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<style>
    th.text-center {
        vertical-align: middle !important;
    }
    html, body {
        background-color: #45494E;
        color: #f2f4f7;
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
        background-attachment: fixed;
        overflow-y: hidden;
        overflow-x: hidden;
    }

    /* Sobrescreve o container centralizador do base.html */
    .container.mt-4, .container {
        width: 100vw !important;
        max-width: 100vw !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .container-page {
        width: 100vw;
        max-width: 100vw;
        margin: 0;
        padding: 0;
        position: relative;
        overflow-x: hidden;
    }
    .content-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,.06);
        padding: 1.2rem 1rem;
        margin-bottom: 1.5rem;
        overflow-x: hidden;
    }
    .content-card .form-label { font-size: .9rem; color: #888; margin-bottom: .25rem; }
    .content-card .form-select, .content-card .form-control {
        border-radius: 8px; border: 1px solid #e3e3e3; font-size: 0.9rem;
        height: 38px;
        padding: 0.375rem 0.75rem;
    }
    .content-card .btn { font-size: 0.9rem; font-weight: 500; padding: 0.375rem 0.75rem; }
    .modern-filters {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    .modern-filters .form-label { font-size: 0.8rem; color: #888; margin-bottom: 0.2rem; }
    .modern-filters .form-select, .modern-filters .form-control {
        border-radius: 6px; border: 1px solid #e3e3e3; font-size: 0.8rem;
        height: 32px;
        padding: 0.25rem 0.5rem;
    }
    .modern-filters .btn { 
        font-size: 0.8rem; 
        font-weight: 500; 
        padding: 0.25rem 0.5rem;
        height: 32px;
    }
    
    /* Responsividade para campos menores */
         @media (max-width: 768px) {
         .modern-filters .form-control,
         .modern-filters .form-select {
             font-size: 0.75rem;
             height: 30px;
             padding: 0.2rem 0.4rem;
         }
         .modern-filters .btn {
             font-size: 0.75rem;
             padding: 0.2rem 0.4rem;
             height: 30px;
         }
         .col-md-2, .col-md-3 {
             flex: 0 0 50%;
             max-width: 50%;
         }
         .table th, .table td {
             font-size: 0.65rem;
             padding: 0.3rem 0.15rem;
         }
         .table-responsive {
             max-height: 50vh;
         }
         .table {
             min-width: 800px;
         }
     }
    
         @media (max-width: 576px) {
         .col-md-2, .col-md-3, .col-6 {
             flex: 0 0 100%;
             max-width: 100%;
         }
         .modern-filters {
             padding: 0.5rem;
         }
         .table-responsive {
             max-height: 40vh;
         }
         .table {
             min-width: 600px;
         }
         .table th, .table td {
             font-size: 0.6rem;
             padding: 0.2rem 0.1rem;
         }
     }
    
    .table-wrap { margin-bottom: 2rem; }
         .table-responsive { 
         overflow-y: auto;
         overflow-x: auto;
         max-height: 60vh;
         border: 1px solid #dee2e6;
         border-radius: 8px;
         position: relative;
     }
    .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
         .table {
         margin-bottom: 0;
         width: 100%;
         table-layout: auto;
         min-width: 1200px;
     }
    .table th {
        position: sticky;
        top: 0;
        background: #343a40;
        color: white;
        z-index: 10;
        white-space: nowrap;
        font-size: 0.75rem;
        padding: 0.4rem 0.2rem;
        overflow: hidden;
        text-overflow: ellipsis;
    }
                   .table td {
          white-space: normal;
          vertical-align: middle;
          font-size: 0.7rem;
          padding: 0.4rem 0.2rem;
          overflow: visible;
          word-wrap: break-word;
          word-break: break-word;
          max-width: 120px;
          min-width: 60px;
          height: auto;
          min-height: 40px;
      }
    
         .table td:hover {
         background-color: #f8f9fa;
     }
    
         
    .badge { font-size: 0.95rem; padding: 0.4em 0.7em; border-radius: 0.5em; }
    .btn-action { min-width: 120px; margin-right: 0.5rem; }
    .pagination .page-link { color: #007bff; border-color: #dee2e6; }
    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: #fff;
    }
    .pagination .page-link:hover {
        background-color: #e9ecef;
        border-color: #007bff;
        color: #007bff;
    }
    /* Estilo para o container principal */
    .container-page {
        overflow-y: auto;
        max-height: 100vh;
    }
    .container-page::-webkit-scrollbar {
        width: 10px;
    }
    .container-page::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 5px;
    }
    .container-page::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 5px;
    }
    .container-page::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    /* Botão voltar ao topo */
    .back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 20px;
        cursor: pointer;
        z-index: 1000;
        display: none;
        transition: all 0.3s ease;
    }
    .back-to-top:hover {
        background: #0056b3;
        transform: translateY(-2px);
    }
    .back-to-top.show {
        display: block;
    }
</style>

<div class="container-page mt-4 mb-5" style="margin-left:1vw; padding-left:0; width:99vw; max-width:98vw;">
    <div class="panel mb-3">
        <div class="content-card">
           
            <form method="get" action="{% url 'faturamento_list' %}">
                <div class="filters-card modern-filters">
                                         <div class="row g-2 align-items-center">
                         <!-- Primeira linha de filtros -->
                         <div class="col-md-3 col-6 mb-2">
                             <input type="text" name="busca" class="form-control" placeholder="Buscar por nome" value="{{ request.GET.busca }}">
                         </div>
                         <div class="col-md-3 col-6 mb-2">
                             <select name="cliente_filtro" class="form-control dropdown-status">
                                 <option value="">Cliente</option>
                                 {% for cliente in clientes_choices %}
                                     <option value="{{ cliente.id }}" {% if request.GET.cliente_filtro == cliente.id|stringformat:"s" %}selected{% endif %}>{{ cliente.nome }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         <div class="col-md-3 col-6 mb-2">
                             <input type="text" name="cnpj" class="form-control" placeholder="CNPJ" value="{{ request.GET.cnpj }}">
                         </div>
                         <div class="col-md-3 col-6 mb-2">
                             <select name="status_faturamento_filtro" class="form-control dropdown-status">
                                 <option value="">Status Faturamento</option>
                                 {% for status in status_faturamento_choices %}
                                     <option value="{{ status.0 }}" {% if request.GET.status_faturamento_filtro == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         
                         <!-- Segunda linha de filtros -->
                         <div class="col-md-2 col-6 mb-2">
                             <input type="date" name="data_inicio" class="form-control" placeholder="Data Início" value="{{ request.GET.data_inicio }}">
                         </div>
                         <div class="col-md-2 col-6 mb-2">
                             <input type="date" name="data_fim" class="form-control" placeholder="Data Fim" value="{{ request.GET.data_fim }}">
                         </div>
                         <div class="col-md-2 col-6 mb-2">
                             <select name="motivo_filtro" class="form-control dropdown-status">
                                 <option value="">Motivo</option>
                                 {% for motivo in motivo_choices %}
                                     <option value="{{ motivo.0 }}" {% if request.GET.motivo_filtro == motivo.0 %}selected{% endif %}>{{ motivo.1 }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         <div class="col-md-2 col-6 mb-2">
                             <select name="tipo_produto_filtro" class="form-control dropdown-status">
                                 <option value="">Tipo Produto</option>
                                 {% for produto in tipo_produto_choices %}
                                     <option value="{{ produto.id }}" {% if request.GET.tipo_produto_filtro == produto.id|stringformat:"s" %}selected{% endif %}>{{ produto.nome }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         <div class="col-md-2 col-6 mb-2">
                             <select name="contrato_tipo_filtro" class="form-control dropdown-status">
                                 <option value="">Tipo Contrato</option>
                                 {% for contrato in contrato_tipo_choices %}
                                     <option value="{{ contrato.0 }}" {% if request.GET.contrato_tipo_filtro == contrato.0 %}selected{% endif %}>{{ contrato.1 }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         <div class="col-md-2 col-6 mb-2">
                             <select name="fatura_tipo_filtro" class="form-control dropdown-status">
                                 <option value="">Tipo Fatura</option>
                                 {% for fatura in fatura_tipo_choices %}
                                     <option value="{{ fatura.0 }}" {% if request.GET.fatura_tipo_filtro == fatura.0 %}selected{% endif %}>{{ fatura.1 }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         
                         <!-- Terceira linha de filtros -->
                         <div class="col-md-3 col-6 mb-2">
                             <select name="status" class="form-control dropdown-status">
                                 <option value="">Status</option>
                                 {% for status in status_choices %}
                                     <option value="{{ status.0 }}" {% if request.GET.status == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         <div class="col-md-3 col-6 mb-2">
                             <select name="comercial" class="form-control dropdown-status">
                                 <option value="">Comercial</option>
                                 {% for comercial in comercial_choices %}
                                     <option value="{{ comercial.0 }}" {% if request.GET.comercial == comercial.0 %}selected{% endif %}>{{ comercial.1 }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         <div class="col-md-3 col-6 mb-2">
                             <select name="ordenacao" class="form-control dropdown-status">
                                 <option value="">Ordenar por</option>
                                 <option value="id" {% if request.GET.ordenacao == 'id' %}selected{% endif %}>ID (mais recente)</option>
                                 <option value="-id" {% if request.GET.ordenacao == '-id' %}selected{% endif %}>ID (mais antigo)</option>
                                 <option value="data" {% if request.GET.ordenacao == 'data' %}selected{% endif %}>Data (mais antiga)</option>
                                 <option value="-data" {% if request.GET.ordenacao == '-data' %}selected{% endif %}>Data (mais recente)</option>
                                 <option value="nome__nome" {% if request.GET.ordenacao == 'nome__nome' %}selected{% endif %}>Nome do Cliente (A-Z)</option>
                                 <option value="-nome__nome" {% if request.GET.ordenacao == '-nome__nome' %}selected{% endif %}>Nome do Cliente (Z-A)</option>
                             </select>
                         </div>
                         <div class="col-md-3 col-6 mb-2 d-flex gap-2">
                             <button class="btn btn-success px-3 rounded-pill flex-fill" type="submit">Filtrar</button>
                             <a href="{% url 'faturamento_list' %}" class="btn btn-outline-secondary px-3 rounded-pill flex-fill">Limpar</a>
                         </div>
                     </div>
                </div>
            </form>

                                                                                                       <div class="table-wrap">
                   
                
                   
                   <div class="table-responsive">
                    <table class="table table-striped table-bordered w-100">
                        <thead class="thead-dark">
                            <tr>
                                <th class="text-center">ID</th>
                                <th class="text-center">Data</th>
                                <th class="text-center">Nome</th>
                                <th class="text-center">Status</th>
                                
                                <th class="text-center">Contrato</th>
                                <th class="text-center">CNPJ</th>
                                <th class="text-center">Início do Contrato</th>
                                <th class="text-center">Vigência</th>
                                <th class="text-center">Motivo</th>
                                <th class="text-center">Envio</th>
                                <th class="text-center">Comercial</th>
                                <th class="text-center">Produto</th>
                                <th class="text-center">Quantidade</th>
                                <th class="text-center">Fatura</th>
                                <th class="text-center">Valor Unitário</th>
                                <th class="text-center">Valor Total</th>
                                <th class="text-center">Formas de Pagamento</th>
                                <th class="text-center">Taxa de Envio</th>
                                <th class="text-center">Observações</th>
                                <th class="text-center">Atualização</th>
                                <th class="text-center">Status Faturamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in requisicoes %}
                                                         <tr class="status-{{ registro.status|lower }}" data-id="{{ registro.id }}">
                                 <td title="ID: {{ registro.id }}">{{ registro.id }}</td>
                                 <td title="Data: {{ registro.data|date:'d/m/Y H:i' }}">{{ registro.data|date:"d/m/Y H:i" }}</td>
                                 <td title="{{ registro.nome }}">{{ registro.nome }}</td>
                                 <td title="Status: {{ registro.status }}">{{ registro.status }}</td>
                              
                                 <td title="Contrato: {{ registro.contrato }}">{{ registro.contrato }}</td>
                                 <td title="CNPJ: {{ registro.cnpj }}" style="white-space: nowrap;">{{ registro.cnpj }}</td>
                                 <td title="Início do Contrato: {{ registro.inicio_de_contrato|date:'d/m/Y' }}">{{ registro.inicio_de_contrato|date:"d/m/Y" }}</td>
                                 <td title="Vigência: {{ registro.vigencia }}">{{ registro.vigencia }}</td>
                                 <td title="{{ registro.motivo }}">{{ registro.motivo }}</td>
                                 <td title="Envio: {{ registro.envio }}">{{ registro.envio }}</td>
                                 <td title="Comercial: {{ registro.comercial }}">{{ registro.comercial }}</td>
                                 <td title="Produto: {{ registro.tipo_produto.nome }}">{{ registro.tipo_produto.nome }}</td>
                                 <td class="text-center" title="Quantidade: {{ registro.numero_de_equipamentos }}">{{ registro.numero_de_equipamentos }}</td>
                               
                                 <td title="Fatura: {{ registro.tipo_fatura }}">{{ registro.tipo_fatura }}</td>
                                 <td title="Valor Unitário: {{ registro.valor_unitario }}">{{ registro.valor_unitario }}</td>
                                 <td title="Valor Total: {{ registro.valor_total }}">{{ registro.valor_total }}</td>
                                 <td title="Formas de Pagamento: {{ registro.forma_pagamento }}">{{ registro.forma_pagamento }}</td>
                                 <td title="Taxa de Envio: {{ registro.taxa_envio }}">{{ registro.taxa_envio }}</td>
                                 <td title="{{ registro.observacoes }}">{{ registro.observacoes }}</td>
                                <td>
                                    <form method="post" action="{% url 'atualizar_observacoes' registro.id %}">
                                        {% csrf_token %}
                                        <input type="text" name="observacoes" class="form-control" value="{{ registro.observacoes }}">
                                        <button type="submit" class="btn btn-primary mt-2">Atualizar</button>
                                    </form>
                                </td>
                                <td>
                                    <form id="status-form-{{ registro.id }}" method="post" action="{% url 'atualizar_status_faturamento' registro.id %}">
                                        {% csrf_token %}
                                        <select name="status_faturamento" class="form-control dropdown-status" onchange="updateStatus('{{ registro.id }}')">
                                            <option value="">Selecione o Status de Faturamento</option>
                                            {% for status in status_faturamento_choices %}
                                                <option value="{{ status.0 }}" {% if registro.status_faturamento == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                                            {% endfor %}
                                        </select>
                                    </form>
                                    <script>
                                    function updateStatus(registroId) {
                                        var form = document.getElementById('status-form-' + registroId);
                                        var formData = new FormData(form);
                                        fetch(form.action, {
                                            method: 'POST',
                                            body: formData,
                                            headers: {
                                                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                                            }
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            const toast = document.createElement('div');
                                            toast.textContent = 'Status de faturamento atualizado!';
                                            toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#2f955f;color:#fff;padding:.6rem .9rem;border-radius:.5rem;box-shadow:0 10px 20px rgba(0,0,0,.2);z-index:9999;font-weight:600;';
                                            document.body.appendChild(toast);
                                            setTimeout(() => toast.remove(), 2000);
                                        })
                                        .catch(error => {
                                            alert('Erro ao atualizar o status: ' + error);
                                        });
                                    }
                                    </script>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="23" class="text-center">Nenhum registro encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-3">
                {% if page_obj.has_other_pages %}
                  <nav>
                    <ul class="pagination justify-content-center">
                      {% if page_obj.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                            Primeira
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                            Anterior
                          </a>
                        </li>
                      {% endif %}

                      {% for page_number in page_obj.paginator.page_range %}
                        {% if page_number <= page_obj.number|add:3 and page_number >= page_obj.number|add:-3 %}
                          {% if page_obj.number == page_number %}
                            <li class="page-item active">
                              <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_number }}">
                                {{ page_number }}
                              </a>
                            </li>
                          {% else %}
                            <li class="page-item">
                              <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_number }}">
                                {{ page_number }}
                              </a>
                            </li>
                          {% endif %}
                        {% endif %}
                      {% endfor %}

                      {% if page_obj.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                            Próxima
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                            Última
                          </a>
                        </li>
                      {% endif %}
                    </ul>
                  </nav>
                {% endif %}
            </div>
        </div>
    </div>

    
   </div>

     <!-- Botão voltar ao topo -->
 <button class="back-to-top" onclick="scrollToTop()" title="Voltar ao topo">
     <i class="fas fa-arrow-up"></i>
 </button>

 <script>
 // Controle do botão voltar ao topo
 window.onscroll = function() {
     const backToTopButton = document.querySelector('.back-to-top');
     if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
         backToTopButton.classList.add('show');
     } else {
         backToTopButton.classList.remove('show');
     }
 };

 function scrollToTop() {
     window.scrollTo({
         top: 0,
         behavior: 'smooth'
     });
 }

               // Melhorar a experiência de scroll na tabela
    document.addEventListener('DOMContentLoaded', function() {
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            // Adicionar indicador visual quando há scroll vertical
            tableContainer.addEventListener('scroll', function() {
                if (this.scrollTop > 0) {
                    this.style.boxShadow = 'inset 0 5px 5px -5px rgba(0,0,0,0.1)';
                } else {
                    this.style.boxShadow = 'none';
                }
            });
        }
    });
 </script>
 {% endblock %}
