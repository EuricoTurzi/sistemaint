{% extends 'base.html' %}
{% block title %}Editar Reativação Completa{% endblock %}

{% include 'components/_header.html' %}
{% block content %}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i> Editar Reativação Completa - ID: {{ reativacao.id }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" id="reativacao-form">
                        {% csrf_token %}
                        
                        <!-- Formulário Principal da Reativação -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-info-circle"></i> Informações da Reativação
                                </h5>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.nome.id_for_label }}" class="font-weight-bold">
                                        <i class="fas fa-user"></i> Cliente
                                    </label>
                                    {{ form.nome }}
                                    {% if form.nome.errors %}
                                        <div class="text-danger small">{{ form.nome.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.motivo_reativacao.id_for_label }}" class="font-weight-bold">
                                        <i class="fas fa-exclamation-triangle"></i> Motivo da Reativação
                                    </label>
                                    {{ form.motivo_reativacao }}
                                    {% if form.motivo_reativacao.errors %}
                                        <div class="text-danger small">{{ form.motivo_reativacao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.canal_solicitacao.id_for_label }}" class="font-weight-bold">
                                        <i class="fas fa-phone"></i> Canal de Solicitação
                                    </label>
                                    {{ form.canal_solicitacao }}
                                    {% if form.canal_solicitacao.errors %}
                                        <div class="text-danger small">{{ form.canal_solicitacao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.cnpj.id_for_label }}" class="font-weight-bold">
                                        <i class="fas fa-building"></i> CNPJ
                                    </label>
                                    {{ form.cnpj }}
                                    {% if form.cnpj.errors %}
                                        <div class="text-danger small">{{ form.cnpj.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.status_reativacao.id_for_label }}" class="font-weight-bold">
                                        <i class="fas fa-check-circle"></i> Status da Reativação
                                    </label>
                                    {{ form.status_reativacao }}
                                    {% if form.status_reativacao.errors %}
                                        <div class="text-danger small">{{ form.status_reativacao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.observacoes.id_for_label }}" class="font-weight-bold">
                                        <i class="fas fa-sticky-note"></i> Observações
                                    </label>
                                    {{ form.observacoes }}
                                    {% if form.observacoes.errors %}
                                        <div class="text-danger small">{{ form.observacoes.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Formset para IdIccid -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-success border-bottom pb-2">
                                    <i class="fas fa-microchip"></i> Equipamentos (ID/ICCID)
                                </h5>
                                <p class="text-muted small">
                                    <i class="fas fa-info-circle"></i> 
                                    Adicione, edite ou remova equipamentos relacionados a esta reativação.
                                </p>
                            </div>
                        </div>

                        {{ formset.management_form }}
                        
                        <div id="formset-container">
                            {% for form in formset %}
                                <div class="formset-form card mb-3 border-info">
                                    <div class="card-header bg-info text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>
                                                <i class="fas fa-microchip"></i> 
                                                Equipamento #{{ forloop.counter }}
                                            </span>
                                            {% if form.instance.pk %}
                                                <span class="badge badge-light">ID: {{ form.instance.pk }}</span>
                                            {% endif %}
                                            <!-- Removido botão de remover -->
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.id_equipamentos.id_for_label }}" class="font-weight-bold">
                                                        <i class="fas fa-id-card"></i> ID dos Equipamentos
                                                    </label>
                                                    {{ form.id_equipamentos }}
                                                    <small class="form-text text-muted">
                                                        Digite um ID por linha
                                                    </small>
                                                    {% if form.id_equipamentos.errors %}
                                                        <div class="text-danger small">{{ form.id_equipamentos.errors }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.ccid_equipamentos.id_for_label }}" class="font-weight-bold">
                                                        <i class="fas fa-sim-card"></i> ICCID dos Equipamentos
                                                    </label>
                                                    {{ form.ccid_equipamentos }}
                                                    <small class="form-text text-muted">
                                                        Digite um ICCID por linha
                                                    </small>
                                                    {% if form.ccid_equipamentos.errors %}
                                                        <div class="text-danger small">{{ form.ccid_equipamentos.errors }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.quantidade.id_for_label }}" class="font-weight-bold">
                                                        <i class="fas fa-hashtag"></i> Quantidade
                                                    </label>
                                                    {{ form.quantidade }}
                                                    <small class="form-text text-muted">
                                                        Quantidade calculada automaticamente
                                                    </small>
                                                    {% if form.quantidade.errors %}
                                                        <div class="text-danger small">{{ form.quantidade.errors }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Botões de Ação -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <!-- Removido botão de adicionar equipamento -->
                                        <a href="{% url 'reativacao_list' %}" class="btn btn-secondary ml-2">
                                            <i class="fas fa-arrow-left"></i> Voltar
                                        </a>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Salvar Alterações
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para adicionar novo formulário ao formset
function addFormsetForm() {
    const container = document.getElementById('formset-container');
    const totalForms = document.getElementById('id_idiccids-TOTAL_FORMS');
    const currentForms = parseInt(totalForms.value);
    
    // Clone o último formulário
    const lastForm = container.lastElementChild;
    const newForm = lastForm.cloneNode(true);
    
    // Atualizar os IDs e names dos campos
    const inputs = newForm.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        if (input.name) {
            input.name = input.name.replace(/\d+/, currentForms);
            input.id = input.id.replace(/\d+/, currentForms);
        }
        if (input.type !== 'hidden') {
            input.value = '';
        }
    });
    
    // Atualizar labels
    const labels = newForm.querySelectorAll('label');
    labels.forEach(label => {
        if (label.getAttribute('for')) {
            label.setAttribute('for', label.getAttribute('for').replace(/\d+/, currentForms));
        }
    });
    
    // Atualizar o cabeçalho
    const header = newForm.querySelector('.card-header span');
    if (header) {
        header.innerHTML = `<i class="fas fa-microchip"></i> Equipamento #${currentForms + 1}`;
    }
    
    // Remover badge de ID se existir
    const badge = newForm.querySelector('.badge');
    if (badge) {
        badge.remove();
    }
    
    // Adicionar o novo formulário
    container.appendChild(newForm);
    
    // Atualizar o contador total
    totalForms.value = currentForms + 1;
}

// Função para calcular quantidade automaticamente
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.formset-form');
    forms.forEach(form => {
        const idInput = form.querySelector('input[name*="id_equipamentos"], textarea[name*="id_equipamentos"]');
        const quantidadeInput = form.querySelector('input[name*="quantidade"]');
        
        if (idInput && quantidadeInput) {
            idInput.addEventListener('input', function() {
                const lines = this.value.split('\n').filter(line => line.trim() !== '');
                quantidadeInput.value = lines.length;
            });
        }
    });
});
</script>

<style>
.formset-form {
    transition: all 0.3s ease;
}

.formset-form:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card-header .form-check {
    margin: 0;
}

.card-header .form-check-label {
    margin-left: 5px;
    cursor: pointer;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn {
    border-radius: 5px;
    font-weight: 500;
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-success {
    background-color: #28a745;
    border-color: #28a745;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}
</style>

{% endblock %} 
