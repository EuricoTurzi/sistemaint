{% extends 'base.html' %}
{% block title %}
| Lista de Reativações |
{% endblock %}

{% include 'components/_header.html' %}
{% block content %}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background-color: #45494E; /* Cor de fundo mais escura */
        display: flex;
        flex-direction: column;
        height: 100rem;
        margin: 0;
    }
    .container-fluid {
        padding: 0;
    }
    .row {
        margin: 0;
    }
    .table-responsive {
        padding: 0 15px;
        margin-left: -22rem;
        width: 115rem;
    }
    .form-control {
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .dropdown-status {
        width: 10rem;
    }
    .filter-container {
        display: flex;
        flex-wrap: nowrap;
        gap: 0rem;
    }
    .thead-dark {
        background-color: #344038;
        color: white;
    }
    .equipamento-form {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
    }
</style>

<form method="get" action="{% url 'reativacao_list' %}">
</form>

<div class="table-responsive">
    <!-- Aqui fica a listagem, se necessário -->
</div>

<!-- Formulário de criação de reativação -->
<div class="container mt-4">
  <div class="card mb-4">
    <div class="card-body">
      <form id="reativacao-form" method="post" class="form" enctype="multipart/form-data">
        {% csrf_token %}
        <h4 class="card-title">Formulário de Reativação</h4>
        <!-- Campo: Nome -->
        <div class="mb-3">
          <label for="{{ reativacao_form.nome.id_for_label }}" class="form-label">Nome</label>
          {{ reativacao_form.nome }}
          {% for error in reativacao_form.nome.errors %}
            <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <!-- Campo: Motivo da Reativação -->
        <div class="mb-3">
          <label for="{{ reativacao_form.motivo_reativacao.id_for_label }}" class="form-label">Motivo da Reativação</label>
          {{ reativacao_form.motivo_reativacao }}
          {% for error in reativacao_form.motivo_reativacao.errors %}
            <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <!-- Campo: Canal de Solicitação -->
        <div class="mb-3">
          <label for="{{ reativacao_form.canal_solicitacao.id_for_label }}" class="form-label">Canal de Solicitação</label>
          {{ reativacao_form.canal_solicitacao }}
          {% for error in reativacao_form.canal_solicitacao.errors %}
            <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <!-- Campo: CNPJ -->
        <div class="mb-3">
          <label for="{{ reativacao_form.cnpj.id_for_label }}" class="form-label">CNPJ</label>
          {{ reativacao_form.cnpj }}
          {% for error in reativacao_form.cnpj.errors %}
            <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <!-- Campo: Observações -->
        <div class="mb-3">
          <label for="{{ reativacao_form.observacoes.id_for_label }}" class="form-label">Observações</label>
          {{ reativacao_form.observacoes }}
          {% for error in reativacao_form.observacoes.errors %}
            <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <!-- Campo: Status da Reativação -->
        

        <h4 class="card-title mt-4">Adicionar Equipamentos</h4>
        <div id="equipamento-forms">
          {{ id_iccid_formset.management_form }}
          {% for form in id_iccid_formset %}
                        <div class="row equipamento-form" id="equipamento-form-{{ forloop.counter0 }}">
              <!-- Campo: Quantidade (exibido para o usuário) -->
              <div class="col-md-4 mb-3">
                <label for="{{ form.quantidade.id_for_label }}" class="form-label">Quantidade</label>
                {{ form.quantidade }}
                {% for error in form.quantidade.errors %}
                  <div class="text-danger">{{ error }}</div>
                {% endfor %}
              </div>
              <!-- Campo: ID Equipamento -->
              <div class="col-md-4 mb-3">
                <label for="{{ form.id_equipamentos.id_for_label }}" class="form-label">ID Equipamento</label>
                {{ form.id_equipamentos }}
                {% for error in form.id_equipamentos.errors %}
                  <div class="text-danger">{{ error }}</div>
                {% endfor %}
              </div>
              <!-- Campo: ICCID Equipamento -->
              <div class="col-md-4 mb-3">
                <label for="{{ form.ccid_equipamentos.id_for_label }}" class="form-label">ICCID Equipamento</label>
                {{ form.ccid_equipamentos }}
                {% for error in form.ccid_equipamentos.errors %}
                  <div class="text-danger">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
        

      
        <button type="submit" class="btn btn-primary mt-3">Salvar</button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Função para atualizar o campo "quantidade" de cada formulário, contando as linhas preenchidas em "ID Equipamento"
  function atualizarQuantidade() {
    document.querySelectorAll('.equipamento-form').forEach(function(formDiv) {
      // Seleciona o textarea de ID Equipamento
      var textarea = formDiv.querySelector('textarea[name$="id_equipamentos"]');
      if (textarea) {
        // Conta as linhas não vazias
        var linhas = textarea.value.split(/\r?\n/).filter(function(linha) {
          return linha.trim() !== "";
        }).length;
        // Atualiza o campo "quantidade" correspondente
        var inputQuantidade = formDiv.querySelector('input[name$="quantidade"]');
        if (inputQuantidade) {
          inputQuantidade.value = linhas;
        }
      }
    });
  }

  // Atualiza a quantidade em tempo real ao digitar no campo "ID Equipamento"
  document.querySelectorAll('textarea[name$="id_equipamentos"]').forEach(function(textarea) {
    textarea.addEventListener('input', atualizarQuantidade);
  });

  // Atualiza a quantidade antes de enviar o formulário
  document.getElementById('reativacao-form').addEventListener('submit', function(e) {
    atualizarQuantidade();
  });
});
</script>
{% endblock %}
